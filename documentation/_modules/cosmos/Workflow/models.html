

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cosmos.Workflow.models &mdash; Cosmos v0.5.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Cosmos v0.5.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> COSMOS</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#features">1.1. Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#multi-platform-support">1.2. Multi-platform Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">2. Install</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#requirements">2.1. Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#install-method">2.2. Install Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#experimental-features">2.3. Experimental Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">3. Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#install-configuration-file">3.1. 1. Install Configuration File</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#create-sql-tables-and-load-static-files">3.2. 2. Create SQL Tables and Load Static Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">4. Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#execute-an-example-workflow">4.1. Execute an Example Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#launch-the-web-interface">4.2. Launch the Web Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#terminating-a-workflow">4.3. Terminating a Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#resuming-a-workflow">4.4. Resuming a workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ezflow/index.html">5. Writing Workflows with EZFlow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ezflow/tools.html">1. Defining Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ezflow/workflows.html">2. Designing Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ezflow/examples.html">3. Workflow Code Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">6. Command Line Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cli.html#examples">6.1. Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../shell.html">7. Cosmos Shell</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../shell.html#launch-the-ipython-shell">7.1. Launch the IPython shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../shell.html#interactive-workflow">7.2. Interactive Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../shell.html#filtering">7.3. Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../shell.html#deleting">7.4. Deleting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">8. Advanced Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced.html#setting-custom-job-submission-flags">8.1. Setting Custom Job Submission Flags</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">9. Cosmos FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/index.html">10. API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../API/Workflow.html">10.1. Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/Job.html">10.2. JobManager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">11. Glossary</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">COSMOS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>cosmos.Workflow.models</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for cosmos.Workflow.models</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Workflow models</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#from cosmos import session</span>
<span class="kn">from</span> <span class="nn">cosmos.config</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="kn">from</span> <span class="nn">cosmos.Job.models.jobattempt</span> <span class="kn">import</span> <span class="n">JobAttempt</span>
<span class="k">if</span>   <span class="n">settings</span><span class="p">[</span><span class="s">&#39;DRM&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;local&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cosmos.Job.models.jobmanager_local</span> <span class="kn">import</span> <span class="n">JobManager</span>
<span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;DRM&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LSF&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cosmos.Job.models.jobmanager_lsf</span>   <span class="kn">import</span> <span class="n">JobManager</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cosmos.Job.models.jobmanager_drmaa</span> <span class="kn">import</span> <span class="n">JobManager</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span><span class="p">,</span><span class="n">Count</span>
<span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="kn">import</span> <span class="n">IntegrityError</span>


<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">signal</span>

<span class="kn">from</span> <span class="nn">cosmos.utils.helpers</span> <span class="kn">import</span> <span class="n">validate_name</span><span class="p">,</span><span class="n">validate_not_null</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">folder_size</span><span class="p">,</span> <span class="n">get_workflow_logger</span>
<span class="kn">from</span> <span class="nn">cosmos.utils</span> <span class="kn">import</span> <span class="n">helpers</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">picklefield.fields</span> <span class="kn">import</span> <span class="n">PickledObjectField</span><span class="p">,</span> <span class="n">dbsafe_decode</span>

<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>

<span class="kn">import</span> <span class="nn">pygraphviz</span> <span class="kn">as</span> <span class="nn">pgv</span>

<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">import</span> <span class="nn">signals</span>

<span class="kn">from</span> <span class="nn">cosmos.Workflow.templatetags</span> <span class="kn">import</span> <span class="n">extras</span>

<span class="c">#if (sys.version_info &gt;= (2,7)):</span>
<span class="c">#    from collections import OrderedDict    # default in Python 2.7</span>
<span class="c">#else:</span>
<span class="c">#    from ordereddict import OrderedDict    # for Python 2.6</span>
<span class="kn">from</span> <span class="nn">ordereddict</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="n">status_choices</span><span class="o">=</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;successful&#39;</span><span class="p">,</span><span class="s">&#39;Successful&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;no_attempt&#39;</span><span class="p">,</span><span class="s">&#39;No Attempt&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;in_progress&#39;</span><span class="p">,</span><span class="s">&#39;In Progress&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;failed&#39;</span><span class="p">,</span><span class="s">&#39;Failed&#39;</span><span class="p">)</span>
                <span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskError</span>              <span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TaskValidationError</span>    <span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TaskFileValidationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">WorkflowError</span>          <span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">get_tmp_id</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">i</span>
    <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>

<div class="viewcode-block" id="TaskFile"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskFile">[docs]</a><span class="k">class</span> <span class="nc">TaskFile</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task File</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span>     <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span>     <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fmt</span>      <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c">#file format</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">persist</span>                      <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">deleted_because_intermediate</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param name: This is the name of the file, and is used as the key for obtaining it.</span>
<span class="sd">                     No Tool an have multiple TaskFiles with the same name.  Defaults to ``fmt``.</span>
<span class="sd">        :param fmt:  The format of the file.  Defaults to the extension of ``path``.</span>
<span class="sd">        :param path: The path to the file.  Required.</span>
<span class="sd">        :param basename: (str) The name to use for the file for auto-generated paths.  You must explicitly</span>
<span class="sd">            specify the extension of the filename, if you want one i.e. &#39;myfile.txt&#39; not &#39;myfile&#39;</span>
<span class="sd">        :param persist: (bool) If True, this file will not be deleted even if it is an intermediate</span>
<span class="sd">            file, and workflow.delete_intermediates is turned on.  Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\.([^\.]+)$&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;{0}. Probably malformed path: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_id</span> <span class="o">=</span> <span class="n">get_tmp_id</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;^[\w\.]+$&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TaskFileValidationError</span><span class="p">,</span> <span class="s">&#39;The taskfile.name must be alphanumeric. Failed name is &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">workflow</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskFile.task"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskFile.task">[docs]</a>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The task this TaskFile is an output for&quot;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_output_files__in</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">])</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskFile.file_size"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskFile.file_size">[docs]</a>    <span class="k">def</span> <span class="nf">file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Size of the taskfile&#39;s output_dir&quot;</span>
        <span class="k">return</span> <span class="n">folder_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="n">human_readable</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;NA&#39;</span>

</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sha1sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;#F[{0}:{1}:{2}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="k">else</span> <span class="s">&#39;t_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_id</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@models.permalink</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;taskfile_view&#39;</span><span class="p">,[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>

<div class="viewcode-block" id="TaskFile.delete_because_intermediate"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskFile.delete_because_intermediate">[docs]</a>    <span class="k">def</span> <span class="nf">delete_because_intermediate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes this file and marks it as deleted because it is an intermediate file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">persist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deleting Intermediate file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleted_because_intermediate</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;&quot; &gt; {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span> <span class="c"># overwrite with empty file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">,</span> <span class="s">&quot;{0} should not be deleted because persist=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="Workflow"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow">[docs]</a><span class="k">class</span> <span class="nc">Workflow</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;   </span>
<span class="sd">    This is the master object.  It contains a list of :class:`Stage` which represent a pool of jobs</span>
<span class="sd">    that have no dependencies on each other and can be executed at the same time. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span>                 <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">output_dir</span>           <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>

    <span class="n">jobManager</span>           <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s">&#39;Job.JobManager&#39;</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">dry_run</span>              <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;don&#39;t execute anything&quot;</span><span class="p">)</span>

    <span class="n">max_reattempts</span>       <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">default_queue</span>        <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">delete_intermediates</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Delete intermediate files&quot;</span><span class="p">)</span>

    <span class="c">#cmd_executed = models.CharField(max_length=255,default=None,null=True)</span>

    <span class="n">comments</span>             <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">created_on</span>           <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">finished_on</span>          <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;created_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c">#Validate unique name</span>
        <span class="c"># if Workflow.objects.filter(name=self.name).exclude(pk=self.id).count() &gt;0:</span>
        <span class="c">#     raise ValidationError(&#39;Workflow with name {0} already exists.  Please choose a different one or use .__reload()&#39;.format(self.name))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span> <span class="o">=</span> <span class="n">get_workflow_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.tasks"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.tasks">[docs]</a>    <span class="k">def</span> <span class="nf">tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tasks in this Workflow&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.task_edges"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.task_edges">[docs]</a>    <span class="k">def</span> <span class="nf">task_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Edges in this Workflow&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TaskEdge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.task_tags"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.task_tags">[docs]</a>    <span class="k">def</span> <span class="nf">task_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;TaskTags in this Workflow&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.task_files"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.task_files">[docs]</a>    <span class="k">def</span> <span class="nf">task_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;TaskFiles in this Stage&quot;</span>
        <span class="k">return</span> <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task_output_set__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.wall_time"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.wall_time">[docs]</a>    <span class="k">def</span> <span class="nf">wall_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time between this workflow&#39;s creation and finished datetimes.  Note, this is a timedelta instance, not seconds&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="k">else</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span>

    <span class="c"># not sure if this works so commented</span>
    <span class="c"># @property</span>
    <span class="c"># def total_stage_wall_time(self):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Sum(stage_wall_times).  Can be different from workflow.wall_time due to workflow stops and reloads.</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     times = map(lambda x: x[&#39;finished_on&#39;]-x[&#39;started_on&#39;],Stage.objects.filter(workflow=self).values(&#39;finished_on&#39;,&#39;started_on&#39;))</span>
    <span class="c">#     return reduce(lambda x,y: x+y, filter(lambda wt: wt,times))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.stages"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.stages">[docs]</a>    <span class="k">def</span> <span class="nf">stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stages in this Workflow&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.file_size"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.file_size">[docs]</a>    <span class="k">def</span> <span class="nf">file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Size of the output directory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">folder_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="n">human_readable</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.log_txt"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.log_txt">[docs]</a>    <span class="k">def</span> <span class="nf">log_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the logfile&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Workflow.start"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a workflow.  If a workflow with this name already exists, return the workflow.</span>

<span class="sd">        :param name: (str) A unique name for this workflow. All spaces are converted to underscores. Required.</span>
<span class="sd">        :param restart: (bool) Complete restart the workflow by deleting it and creating a new one. Optional.</span>
<span class="sd">        :param dry_run: (bool) Don&#39;t actually execute jobs. Optional.</span>
<span class="sd">        :param root_output_dir: (bool) Replaces the directory used in settings as the workflow output directory. If None, will use default_root_output_dir in the config file. Optional.</span>
<span class="sd">        :param default_queue: (str) Name of the default queue to submit jobs to. Optional.</span>
<span class="sd">        :param delete_intermediates: (str) Deletes intermediate files to save scratch space.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;root_output_dir&#39;</span><span class="p">,</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;default_root_output_dir&#39;</span><span class="p">])</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;default_queue&#39;</span><span class="p">,</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;default_queue&#39;</span><span class="p">])</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;delete_intermediates&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;comments&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>

        <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;restart&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">prompt_confirm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;prompt_confirm&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>

        <span class="c">#name = re.sub(&quot;\s&quot;,&quot;_&quot;,name)</span>

        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">__restart</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">prompt_confirm</span><span class="o">=</span><span class="n">prompt_confirm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">__reload</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">prompt_confirm</span><span class="o">=</span><span class="n">prompt_confirm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c">#wf = Workflow.__resume(name=name, **kwargs)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">__create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c">#remove stale objects</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">_delete_stale_objects</span><span class="p">()</span>

        <span class="c">#terminate on ctrl+c</span>
        <span class="k">def</span> <span class="nf">ctrl_c</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">ctrl_c</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c">#signal only works in main thread and django complains</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">wf</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__resume</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">default_queue</span><span class="p">,</span> <span class="n">delete_intermediates</span><span class="p">,</span> <span class="n">root_output_dir</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resumes a workflow without deleting any unsuccessful tasks.  Provides a way to override workflow</span>
<span class="sd">        properties.</span>
<span class="sd">        Probably won&#39;t be called by anything except __reload</span>

<span class="sd">        see :py:meth:`start` for parameter definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Workflow {0} does not exist, cannot resume it&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">default_queue</span><span class="o">=</span><span class="n">default_queue</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">delete_intermediates</span> <span class="o">=</span> <span class="n">delete_intermediates</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_output_dir</span><span class="p">,</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Resuming {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__reload</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">default_queue</span><span class="p">,</span> <span class="n">delete_intermediates</span><span class="p">,</span><span class="n">delete_unsuccessful_stages</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prompt_confirm</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resumes a workflow, keeping successful tasks and deleting unsuccessful ones.</span>

<span class="sd">        see :py:meth:`start` for parameter definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO create a delete_stages(stages) method, that works faster than deleting individual stages</span>
        <span class="c">#TODO ideally just change the queryset manager to do this automatically</span>
        <span class="k">if</span> <span class="n">prompt_confirm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s">&quot;Reloading the workflow, are you sure you want to delete any unsuccessful tasks in &#39;{0}&#39;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;Exiting.&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">__resume</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">dry_run</span><span class="p">,</span><span class="n">default_queue</span><span class="p">,</span><span class="n">delete_intermediates</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#Stage.objects.filter(workflow=wf).update(order_in_workflow=None)</span>

        <span class="k">if</span> <span class="n">delete_unsuccessful_stages</span><span class="p">:</span>
            <span class="c">#delete a stage with any unsuccessful tasks</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#delete a stage if ALL tasks are unsuccessful</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">Stage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">wf</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">task__successful</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0} has no successful tasks.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c">#Delete unsuccessful tasks</span>
        <span class="n">utasks</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">num_utasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">utasks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_utasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">bulk_delete_tasks</span><span class="p">(</span><span class="n">utasks</span><span class="p">)</span>

            <span class="c"># Update stages that are resuming</span>
            <span class="n">Stage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">wf</span><span class="p">,</span><span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">task__successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;in_progress&#39;</span><span class="p">,</span><span class="n">finished_on</span><span class="o">=</span><span class="bp">None</span>
            <span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__restart</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">prompt_confirm</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restarts a workflow.  Will delete the old workflow and all of its files</span>
<span class="sd">        but will retain the old workflow id for convenience</span>

<span class="sd">        see :py:meth:`start` for parameter definitions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wf_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">prompt_confirm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s">&quot;Are you sure you want to restart Workflow &#39;{0}&#39;?  All files will be deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;Exiting.&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">old_wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">wf_id</span> <span class="o">=</span> <span class="n">old_wf</span><span class="o">.</span><span class="n">id</span>
            <span class="n">old_wf</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">new_wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">__create</span><span class="p">(</span><span class="n">_wf_id</span><span class="o">=</span><span class="n">wf_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_wf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">root_output_dir</span><span class="p">,</span><span class="n">_wf_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new workflow</span>

<span class="sd">        see :py:meth:`start` for parameter definitions</span>
<span class="sd">        :param _wf_id: the ID to use for creating a workflow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">_wf_id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span> <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Workflow with this _wf_id already exists&#39;</span><span class="p">)</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_output_dir</span><span class="p">,</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">_wf_id</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">jobManager</span> <span class="o">=</span> <span class="n">JobManager</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(),</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Created Workflow {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">wf</span>


<div class="viewcode-block" id="Workflow.add_stage"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.add_stage">[docs]</a>    <span class="k">def</span> <span class="nf">add_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a stage to this workflow.  If a stage with this name (in this Workflow) already exists,</span>
<span class="sd">        and it hasn&#39;t been added in this session yet, return the existing one after removing its</span>
<span class="sd">        finished_on datetimestamp and resetting it&#39;s order_in_workflow</span>

<span class="sd">        :param name: (str) The name of the stage, must be unique within this Workflow. Required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO name can&#39;t be &quot;log&quot; or change log dir to .log</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;\s&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

        <span class="n">stage</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Stage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">min</span><span class="p">,</span><span class="nb">max</span> <span class="o">=</span> <span class="n">Stage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;order_in_workflow&#39;</span><span class="p">),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="s">&#39;order_in_workflow&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">max</span>
        <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Creating {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">order_in_workflow</span> <span class="o">=</span> <span class="nb">max</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Loading {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">stage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stage</span>
</div>
    <span class="k">def</span> <span class="nf">_delete_stale_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes objects that are stale from the database.  This should only happens when the program exists ungracefully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO implement a catch all exception so that this never happens.  i think i can only do this if scripts are not run directly</span>
        <span class="n">JobAttempt</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task_output_set</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<div class="viewcode-block" id="Workflow.terminate"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">exit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminates this workflow and Exits</span>
<span class="sd">        :param exception: an exception to raise after terminating</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Terminating {0}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">jobAttempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">jobAttempts</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">queue_status</span><span class="o">=</span><span class="s">&#39;queued&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Sending Terminate signal to all running jobs.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ja</span> <span class="ow">in</span> <span class="n">jobAttempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">terminate_jobAttempt</span><span class="p">(</span><span class="n">ja</span><span class="p">)</span>

        <span class="c">#this basically a bulk task._has_finished and jobattempt.hasFinished</span>
        <span class="n">task_ids</span> <span class="o">=</span> <span class="n">jobAttempts</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;task&#39;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">task_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Marking {0} terminated Tasks as failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;failed&#39;</span><span class="p">,</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">stages</span> <span class="o">=</span> <span class="n">Stage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="n">tasks</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Marking {0} terminated Stages as failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stages</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="n">stages</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;failed&#39;</span><span class="p">,</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Marking {0} terminated JobAttempts as failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobAttempts</span><span class="p">)))</span>
        <span class="n">jobAttempts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">queue_status</span><span class="o">=</span><span class="s">&#39;finished&#39;</span><span class="p">,</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s">&quot;{0}&lt;br/&gt;{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&quot;terimate()ed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Exiting.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">exit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.get_all_tag_keys_used"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.get_all_tag_keys_used">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_tag_keys_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of all the keyword tags used on any task in this workflow&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span> <span class="p">])</span>
</div>
<div class="viewcode-block" id="Workflow.save_resource_usage_as_csv"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.save_resource_usage_as_csv">[docs]</a>    <span class="k">def</span> <span class="nf">save_resource_usage_as_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save resource usage to filename&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">csv</span>
        <span class="n">profile_fields</span> <span class="o">=</span> <span class="n">JobAttempt</span><span class="o">.</span><span class="n">profile_fields_as_list</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;stage&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_tag_keys_used</span><span class="p">())</span> <span class="o">+</span> <span class="n">profile_fields</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">dict_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="n">dict_writer</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stage_resources</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_stage_resource_usage</span><span class="p">():</span>
            <span class="n">dict_writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">stage_resources</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.yield_stage_resource_usage"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.yield_stage_resource_usage">[docs]</a>    <span class="k">def</span> <span class="nf">yield_stage_resource_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :yields: A dict of all resource usage, tags, and the name of the stage of every task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nru</span><span class="p">)</span> <span class="k">for</span> <span class="n">nru</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">yield_task_resource_usage</span><span class="p">()</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">dicts</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Workflow.bulk_save_tasks"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.bulk_save_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_save_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tasks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does a bulk insert of tasks.  Identical tasks should not be in the database.</span>

<span class="sd">        :param tasks: (list) a list of tasks</span>

<span class="sd">        .. note:: this does not save task-&gt;taskfile relationships</span>

<span class="sd">        &gt;&gt;&gt; tasks = [stage.new_task(pcmd=&#39;cmd1&#39;,save=False,{&#39;i&#39;:1}),stage.new_task(pcmd=&#39;cmd2&#39;,save=False,{&#39;i&#39;:2})]</span>
<span class="sd">        &gt;&gt;&gt; stage.bulk_save_tasks(tasks)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bulk adding {0} Tasks...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)))</span>

        <span class="c">#need to manually set IDs because there&#39;s no way to get them in the right order for tagging after a bulk create</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))[</span><span class="s">&#39;id__max&#39;</span><span class="p">]</span>
        <span class="n">id_start</span> <span class="o">=</span>  <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id_start</span> <span class="o">+</span> <span class="n">i</span>

        <span class="c"># try:</span>
        <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="c"># except IntegrityError as e:</span>
        <span class="c">#     for tpl, tasks in helpers.groupby(tasks + list(self.tasks), lambda t: (t.tags,t.stage)):</span>
        <span class="c">#         if len(list(tasks)) &gt; 1:</span>
        <span class="c">#             print &#39;ERROR! Duplicate tags in {0}, which are:&#39;.format(tpl[1])</span>
        <span class="c">#             pprint.pprint(tpl[0])</span>
        <span class="c">#</span>
        <span class="c">#     raise(IntegrityError(&#39;{0}&#39;.format(e)))</span>

        <span class="c">#create output directories</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir -p {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">job_output_dir</span><span class="p">))</span>
            <span class="c">#os.mkdir(t.job_output_dir) #this is not in JobManager because JobManager should be not care about these details</span>

        <span class="c">### Bulk add tags</span>
        <span class="n">tasktags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tasktags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TaskTag</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bulk adding {0} TaskTags...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tasktags</span><span class="p">)))</span>
        <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">tasktags</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c">### Reset status of stages with new tasks</span>
<span class="c">#        reset_stages_pks = set(map(lambda t: t.stage.pk, tasks))</span>
<span class="c">#        Stage.objects.filter(id__in=reset_stages_pks).update(status=&quot;no_attempt&quot;,finished_on=None)</span>

        <span class="k">return</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Workflow.bulk_save_taskfiles"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.bulk_save_taskfiles">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_save_taskfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskfiles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param taskfiles: (list) A list of taskfiles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bulk adding {0} TaskFiles...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taskfiles</span><span class="p">)))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))[</span><span class="s">&#39;id__max&#39;</span><span class="p">]</span>
        <span class="n">id_start</span> <span class="o">=</span>  <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taskfiles</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id_start</span> <span class="o">+</span> <span class="n">i</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">taskfiles</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;{0}.  There are probably multiple tasks with the same output files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Workflow.bulk_save_task_edges"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.bulk_save_task_edges">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_save_task_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edges</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param edges: [(parent, child),...] A list of tuples of parent -&gt; child relationships</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">### Bulk add parents</span>
        <span class="n">task_edges</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">TaskEdge</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">child</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">edges</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bulk adding {0} TaskEdges...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">task_edges</span><span class="p">)))</span>
        <span class="n">TaskEdge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">task_edges</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Workflow.bulk_delete_tasks"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.bulk_delete_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_delete_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tasks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bulk deletes tasks and their related objects&quot;&quot;&quot;</span>
        <span class="n">task_output_dirs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="n">tasks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bulk deleting {0} tasks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk deleting JobAttempts...&#39;</span><span class="p">)</span>
        <span class="n">JobAttempt</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk deleting TaskTags...&#39;</span><span class="p">)</span>
        <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="n">tasks</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk deleting TaskEdges...&#39;</span><span class="p">)</span>
        <span class="n">TaskEdge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk deleting TaskFiles...&#39;</span><span class="p">)</span>
        <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task_output_set__in</span><span class="o">=</span><span class="n">tasks</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk deleting Tasks...&#39;</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deleting Task output directories&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">task_output_dirs</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

    <span class="c">#TODO this probably doesn&#39;t have to be a transaction</span></div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Workflow.delete"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes this workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Deleting {0} and it&#39;s output dir {1}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
        <span class="n">save_str_representation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">wf_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_delete_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Bulk Deleting Stages...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0} Deleted.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_str_representation</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wf_output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and submits and JobAttempt.</span>

<span class="sd">        :param task: the task to submit a JobAttempt for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">NOOP</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;NOOP&#39;</span>

        <span class="c">#TODO fix this it&#39;s slow (do it in bulk when running a workflow?)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;no_attempt&#39;</span><span class="p">,</span><span class="s">&#39;failed&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;no_attempt&#39;</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">started_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;in_progress&#39;</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;in_progress&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Running {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>

        <span class="n">task</span><span class="o">.</span><span class="n">exec_command</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">pcmd</span>

        <span class="c">#set output_file paths to the task&#39;s job_output_dir</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">output_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="s">&#39;{0}.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;out&#39;</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">fmt</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">fmt</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">basename</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">basename</span>
                <span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">job_output_dir</span><span class="p">,</span><span class="n">basename</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s">&#39;dir&#39;</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c">#Replace TaskFile hashes with their paths</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;(#F\[(.+?):(.+?):(.+?)\])&#39;</span><span class="p">,</span><span class="n">task</span><span class="o">.</span><span class="n">exec_command</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">taskfile</span> <span class="o">=</span> <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">task</span><span class="o">.</span><span class="n">exec_command</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">exec_command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">taskfile</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;{0}.  Task is {1}. Taskfile str is {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;{0}. m[0] is {0} and taskfile is {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">taskfile</span><span class="p">))</span>

        <span class="n">jobAttempt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">add_jobAttempt</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">exec_command</span><span class="p">,</span>
            <span class="n">jobName</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Dry Run: skipping submission of job {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Submitted jobAttempt with drmaa jobid {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobAttempt</span><span class="o">.</span><span class="n">drmaa_jobID</span><span class="p">))</span>
        <span class="n">task</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jobAttempt</span>


    <span class="k">def</span> <span class="nf">_reattempt_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">failed_jobAttempt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reattempt running a task.</span>

<span class="sd">        :param task: (Task) the task to reattempt</span>
<span class="sd">        :param failed_jobAttempt: (bool) the previously failed jobAttempt of the task</span>
<span class="sd">        :returns: (bool) True if another jobAttempt was submitted, False if the max jobAttempts has already been reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numAttempts</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">jobAttempts</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">successful</span><span class="p">:</span> <span class="c">#ReRun jobAttempt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;{0} of {1} failed, on attempt # {2}, so deleting failed output files and retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_jobAttempt</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">numAttempts</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s">&quot;&lt;COMMAND path=</span><span class="se">\&quot;</span><span class="s">{1}</span><span class="se">\&quot;</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">{0}</span><span class="se">\n</span><span class="s">&lt;/COMMAND&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_jobAttempt</span><span class="o">.</span><span class="n">get_command_shell_script_text</span><span class="p">(),</span><span class="n">failed_jobAttempt</span><span class="o">.</span><span class="n">command_script_path</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s">&quot;&lt;STDERR&gt;</span><span class="se">\n</span><span class="s">{0}</span><span class="se">\n</span><span class="s">&lt;/STDERR&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_jobAttempt</span><span class="o">.</span><span class="n">STDERR_txt</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">numAttempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_reattempts</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">job_output_dir</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;{0} has failed and reached max_reattempts of {1}.</span><span class="se">\n</span><span class="s">&lt;STDERR&gt;</span><span class="se">\n</span><span class="s">{2}</span><span class="se">\n</span><span class="s">&lt;/STDERR&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_reattempts</span><span class="p">,</span><span class="n">failed_jobAttempt</span><span class="o">.</span><span class="n">STDERR_txt</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;failed&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>


<div class="viewcode-block" id="Workflow.run"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">terminate_on_fail</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">finish</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a workflow using the DAG of jobs</span>

<span class="sd">        :param terminate_on_fail: (bool) If True, the workflow will self terminate of any of the tasks of this stage fail `max_job_attempts` times</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Generating DAG...&quot;</span><span class="p">)</span>
        <span class="n">wfDAG</span> <span class="o">=</span> <span class="n">WorkflowManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running DAG.&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">run_ready_tasks</span><span class="p">():</span>
            <span class="n">submitted_tasks</span> <span class="o">=</span> <span class="n">wfDAG</span><span class="o">.</span><span class="n">run_ready_tasks</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">submitted_tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">NOOP</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">_has_finished</span><span class="p">(</span><span class="s">&#39;NOOP&#39;</span><span class="p">)</span>
                    <span class="n">wfDAG</span><span class="o">.</span><span class="n">complete_task</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">submitted_tasks</span><span class="p">:</span>
                <span class="n">run_ready_tasks</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_ready_tasks</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">jobAttempt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobManager</span><span class="o">.</span><span class="n">yield_all_queued_jobs</span><span class="p">():</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">jobAttempt</span><span class="o">.</span><span class="n">task</span>
                <span class="c">#self.log.info(&#39;Finished {0} for {1} of {2}&#39;.format(jobAttempt,task,task.stage))</span>
                <span class="k">if</span> <span class="n">jobAttempt</span><span class="o">.</span><span class="n">successful</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">succeed_on_failure</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">_has_finished</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">)</span>
                    <span class="n">wfDAG</span><span class="o">.</span><span class="n">complete_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">run_ready_tasks</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reattempt_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">jobAttempt</span><span class="p">):</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">_has_finished</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">)</span> <span class="c">#job has failed and out of reattempts</span>
                        <span class="k">if</span> <span class="n">terminate_on_fail</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;{0} of {1} has reached max_reattempts and terminate_on_fail==True so terminating.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobAttempt</span><span class="p">,</span><span class="n">task</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">finish</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;An exception was raised during workflow execution, terminating workflow and then re-raising exception.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="nb">exit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="Workflow.finished"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.finished">[docs]</a>    <span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call at the end of every workflow.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finished {0}, last stage&#39;s output dir: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-order_in_workflow&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Workflow.get_tasks_by"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.get_tasks_by">[docs]</a>    <span class="k">def</span> <span class="nf">get_tasks_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="p">{},</span><span class="n">op</span><span class="o">=</span><span class="s">&quot;and&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of tasks that are tagged by the keys and vals in tags dictionary</span>

<span class="sd">        :param op: (str) either &#39;and&#39; or &#39;or&#39; as the logic to filter tags with</span>
<span class="sd">        :param tags: (dict) tags to filter for</span>
<span class="sd">        :returns: (queryset) a queryset of the filtered tasks</span>

<span class="sd">        &gt;&gt;&gt; task.get_tools_by(op=&#39;or&#39;,tags={&#39;color&#39;:&#39;grey&#39;,&#39;color&#39;:&#39;orange&#39;})</span>
<span class="sd">        &gt;&gt;&gt; task.get_tools_by(op=&#39;and&#39;,tags={&#39;color&#39;:&#39;grey&#39;,&#39;shape&#39;:&#39;square&#39;})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;or&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s">&#39;sorry&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">tasks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span>

        <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">return</span> <span class="n">tasks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tasktag__key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">tasktag__value</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">tasks</span>
</div>
<div class="viewcode-block" id="Workflow.get_task_by"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Workflow.get_task_by">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="p">{},</span><span class="n">stage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="s">&quot;and&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of tasks that are tagged by the keys and vals in tags dictionary.</span>

<span class="sd">        :raises Exception: if more or less than one task is returned</span>

<span class="sd">        :param op: (str) Choose either &#39;and&#39; or &#39;or&#39; as the logic to filter tags with</span>
<span class="sd">        :param tags: (dict) A dictionary of tags you&#39;d like to filter for</span>
<span class="sd">        :returns: (queryset) a queryset of the filtered tasks</span>

<span class="sd">        &gt;&gt;&gt; task.get_task_by(op=&#39;or&#39;,tags={&#39;color&#39;:&#39;grey&#39;,&#39;color&#39;:&#39;orange&#39;})</span>
<span class="sd">        &gt;&gt;&gt; task.get_task_by(op=&#39;and&#39;,tags={&#39;color&#39;:&#39;grey&#39;,&#39;color&#39;:&#39;orange&#39;})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tasks_by</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span> <span class="c">#there&#39;s just one group of tasks with this tag combination</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;More than one task with tags {0} in {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">stage</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;No tasks with with tags {0}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Workflow[{0}] {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;&quot;output_dir: {0.output_dir}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@models.permalink</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;workflow_view&#39;</span><span class="p">,[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>

</div>
<span class="k">class</span> <span class="nc">WorkflowManager</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">workflow</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using DAG to create Job Queue&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag_queue</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queued_tasks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">queue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queued_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_ready_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ready_tasks</span> <span class="o">=</span> <span class="p">[</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ready_tasks</span><span class="p">()</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ready_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_task</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_run_task</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ready_tasks</span>

    <span class="k">def</span> <span class="nf">complete_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag_queue</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span>

        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;successful&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">delete_intermediates</span><span class="p">:</span>
            <span class="c"># Input files may be ready for intermediate deleting if all</span>
            <span class="c"># Tasks that depend on them are also successful, and they are not an input file (ie has &gt;0 parents)</span>
            <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">input_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">infile</span><span class="o">.</span><span class="n">persist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;successful&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;_parents__count&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>
                              <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">task_input_set</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;successful&#39;</span><span class="p">,</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;_parents&#39;</span><span class="p">))</span> <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">infile</span><span class="o">.</span><span class="n">delete_because_intermediate</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>


    <span class="c"># def is_task_intermediate(self,task_id):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Checks to see if a task_id is an intermediary task.</span>
    <span class="c">#     An intermediary task has at least 1 child and 1 parent, and all of its children are all successful.</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     successors = self.dag.successors(task_id)</span>
    <span class="c">#     if len(self.dag.predecessors(task_id)) &gt; 0 and len(successors) &gt; 0:</span>
    <span class="c">#         return all( self.dag.node[s][&#39;status&#39;] == &#39;successful&#39; for s in successors )</span>

    <span class="k">def</span> <span class="nf">get_ready_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">degree_0_tasks</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_queue</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queued_tasks</span><span class="p">,</span><span class="n">degree_0_tasks</span><span class="p">))</span>
        <span class="c">#return map(lambda n_id: Task.objects.get(pk=n_id),filter(lambda x: x not in self.queued_tasks,degree_0_tasks)) </span>

    <span class="k">def</span> <span class="nf">createDiGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="n">dag</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="n">ne</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">],</span><span class="n">ne</span><span class="p">[</span><span class="s">&#39;child&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">task_edges</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">,</span><span class="s">&#39;child&#39;</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="n">stage_name</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">dag</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span><span class="n">stage</span><span class="o">=</span><span class="n">stage_name</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">url</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">dag</span>

    <span class="k">def</span> <span class="nf">createAGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">fontname</span><span class="o">=</span><span class="s">&quot;Courier&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="n">dag</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fontname&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;Courier&quot;</span>
        <span class="n">dag</span><span class="o">.</span><span class="n">node_attr</span><span class="p">[</span><span class="s">&#39;fontsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">8</span>
        <span class="n">dag</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">stage</span><span class="p">,</span><span class="n">tasks</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;stage&#39;</span><span class="p">]):</span>
            <span class="n">sg</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cluster_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stage</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;lightgrey&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">attrs</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">truncate_val</span><span class="p">(</span><span class="n">kv</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">10</span> <span class="k">else</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;..&#39;</span>
                    <span class="k">return</span> <span class="s">&quot;{0}: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s">&quot; </span><span class="se">\\</span><span class="s">n&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">truncate_val</span><span class="p">,</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">status2color</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;no_attempt&#39;</span><span class="p">:</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="s">&#39;in_progress&#39;</span><span class="p">:</span><span class="s">&#39;gold1&#39;</span><span class="p">,</span><span class="s">&#39;successful&#39;</span><span class="p">:</span> <span class="s">&#39;darkgreen&#39;</span><span class="p">,</span><span class="s">&#39;failed&#39;</span><span class="p">:</span><span class="s">&#39;darkred&#39;</span><span class="p">}</span>
                <span class="n">sg</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">URL</span><span class="o">=</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">target</span><span class="o">=</span><span class="s">&quot;_blank&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">status2color</span><span class="p">[</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">dag</span>


    <span class="k">def</span> <span class="nf">as_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&quot;svg&quot;</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createAGraph</span><span class="p">()</span>
        <span class="c">#g = self.createAGraph(self.get_simple_dag())</span>
        <span class="c">#g=nx.to_agraph(self.get_simple_dag())</span>
        <span class="n">g</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&quot;dot&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createAGraph</span><span class="p">()</span>
        <span class="c">#g = self.createAGraph(self.get_simple_dag())</span>
        <span class="c">#g=nx.to_agraph(self.get_simple_dag())</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>


<div class="viewcode-block" id="Stage"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage">[docs]</a><span class="k">class</span> <span class="nc">Stage</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A group of jobs that can be run independently.  See `Embarassingly Parallel &lt;http://en.wikipedia.org/wiki/Embarrassingly_parallel&gt;`_ .</span>
<span class="sd">    </span>
<span class="sd">    .. note:: A Stage should not be directly instantiated, use :py:func:`Workflow.models.Workflow.add_stage` to create a new stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span>        <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="n">workflow</span>    <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Workflow</span><span class="p">)</span>

    <span class="n">order_in_workflow</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">#   status      = models.CharField(max_length=200,choices=status_choices,default=&#39;no_attempt&#39;)</span>
    <span class="n">status</span>      <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;no_attempt&#39;</span><span class="p">)</span>

    <span class="n">successful</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">started_on</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">created_on</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">finished_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;workflow&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;created_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Stage</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">validate_not_null</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">)</span>

        <span class="n">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c">#mkdir_p(self.output_dir)</span>

<div class="viewcode-block" id="Stage.set_status"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_status</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Set Stage status&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>

        <span class="k">if</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s">&#39;successful&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">successful</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">log</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.percent_done"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.percent_done">[docs]</a>    <span class="k">def</span> <span class="nf">percent_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Percent of tasks that have completed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;in_progress&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;failed&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
</div>
    <span class="k">def</span> <span class="nf">failed_jobAttempts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JobAttempt</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span><span class="n">queue_status</span><span class="o">=</span><span class="s">&#39;finished&#39;</span><span class="p">,</span><span class="n">successful</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<div class="viewcode-block" id="Stage.get_stats"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param: a list of 3-tuples of format (title,field,statistic)</span>
<span class="sd">        :return: (dict) of stats about jobs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats_to_get</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;avg_percent_cpu&#39;</span><span class="p">,</span><span class="s">&#39;percent_cpu&#39;</span><span class="p">,</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_percent</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;avg_wall_time&#39;</span><span class="p">,</span><span class="s">&#39;wall_time&#39;</span><span class="p">,</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_time</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;max_wall_time&#39;</span><span class="p">,</span><span class="s">&#39;wall_time&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_time</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;avg_block_io_delays&#39;</span><span class="p">,</span><span class="s">&#39;block_io_delays&#39;</span><span class="p">,</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_time</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;avg_rss_mem&#39;</span><span class="p">,</span><span class="s">&#39;avg_rss_mem&#39;</span><span class="p">,</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_memory_kb</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;max_rss_mem&#39;</span><span class="p">,</span><span class="s">&#39;max_rss_mem&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_memory_kb</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;avg_virtual_mem&#39;</span><span class="p">,</span><span class="s">&#39;avg_virtual_mem&#39;</span><span class="p">,</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="n">extras</span><span class="o">.</span><span class="n">format_memory_kb</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats_to_get</span> <span class="p">]</span>
        <span class="n">aggregate_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">statistic</span><span class="p">,</span><span class="n">formatfxn</span> <span class="ow">in</span> <span class="n">stats_to_get</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">statistic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="s">&#39;Sum&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">,</span><span class="s">&#39;Min&#39;</span><span class="p">,</span><span class="s">&#39;Count&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Statistic {0} not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statistic</span><span class="p">))</span>
            <span class="n">aggr_fxn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span>
            <span class="n">aggregate_kwargs</span><span class="p">[</span><span class="n">title</span><span class="p">]</span><span class="o">=</span> <span class="n">aggr_fxn</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_jobAttempts</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="o">**</span><span class="n">aggregate_kwargs</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">stat</span><span class="p">,</span><span class="n">formatfxn</span> <span class="ow">in</span> <span class="n">stats_to_get</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatfxn</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">title</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">d</span>


    <span class="c">#TODO deprecated</span></div>
<div class="viewcode-block" id="Stage.get_sjob_stat"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_sjob_stat">[docs]</a>    <span class="k">def</span> <span class="nf">get_sjob_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">statistic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregates a task successful job&#39;s field using a statistic.</span>
<span class="sd">        :param field: (str) name of a tasks&#39;s field.  ex: wall_time or avg_rss_mem</span>
<span class="sd">        :param statistic: (str) choose from [&#39;Avg&#39;,&#39;Sum&#39;,&#39;Max&#39;,&#39;Min&#39;,&#39;Count&#39;]</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; stage.get_stat(&#39;wall_time&#39;,&#39;Avg&#39;)</span>
<span class="sd">        120</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">statistic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="s">&#39;Sum&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">,</span><span class="s">&#39;Min&#39;</span><span class="p">,</span><span class="s">&#39;Count&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Statistic {0} not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statistic</span><span class="p">))</span>
        <span class="n">aggr_fxn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span>
        <span class="n">aggr_field</span> <span class="o">=</span> <span class="s">&#39;{0}__{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_jobAttempts</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggr_fxn</span><span class="p">(</span><span class="n">field</span><span class="p">))[</span><span class="n">aggr_field</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">successful_jobAttempts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JobAttempt</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">task__in</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

<div class="viewcode-block" id="Stage.get_task_stat"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_task_stat">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">statistic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregates a task&#39;s field using a statistic</span>
<span class="sd">        :param field: (str) name of a tasks&#39;s field.  ex: cpu_req, mem_req</span>
<span class="sd">        :param statistic: (str) choose from [&#39;Avg&#39;,&#39;Sum&#39;,&#39;Max&#39;,&#39;Min&#39;,&#39;Count&#39;]</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; stage.get_stat(&#39;cpu_requirement&#39;,&#39;Avg&#39;)</span>
<span class="sd">        120</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">statistic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Avg&#39;</span><span class="p">,</span><span class="s">&#39;Sum&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">,</span><span class="s">&#39;Min&#39;</span><span class="p">,</span><span class="s">&#39;Count&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Statistic {0} not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statistic</span><span class="p">))</span>
        <span class="n">aggr_fxn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span>
        <span class="n">aggr_field</span> <span class="o">=</span> <span class="s">&#39;{0}__{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggr_fxn</span><span class="p">(</span><span class="n">field</span><span class="p">))[</span><span class="n">aggr_field</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="n">r</span>

</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.file_size"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.file_size">[docs]</a>    <span class="k">def</span> <span class="nf">file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Size of the stage&#39;s output_dir&quot;</span>
        <span class="k">return</span> <span class="n">folder_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="n">human_readable</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.wall_time"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.wall_time">[docs]</a>    <span class="k">def</span> <span class="nf">wall_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time between this stage&#39;s creation and finished datetimes.  Note, this is a timedelta instance, not seconds&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_on</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="k">else</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_on</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.output_dir"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Absolute path to this stage&#39;s output_dir&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.tasks"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.tasks">[docs]</a>    <span class="k">def</span> <span class="nf">tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Queryset of this stage&#39;s tasks&quot;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.task_edges"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.task_edges">[docs]</a>    <span class="k">def</span> <span class="nf">task_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Edges in this Stage&quot;</span>
        <span class="k">return</span> <span class="n">TaskEdge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.task_tags"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.task_tags">[docs]</a>    <span class="k">def</span> <span class="nf">task_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;TaskTags in this Stage&quot;</span>
        <span class="k">return</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.task_files"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.task_files">[docs]</a>    <span class="k">def</span> <span class="nf">task_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;TaskFiles in this Stage&quot;</span>
        <span class="k">return</span> <span class="n">TaskFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task_output_set__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.num_tasks"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.num_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">num_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The number of tasks in this stage&quot;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.num_tasks_successful"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.num_tasks_successful">[docs]</a>    <span class="k">def</span> <span class="nf">num_tasks_successful</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Number of successful tasks in this stage&quot;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Stage.get_all_tag_keys_used"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_all_tag_keys_used">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_tag_keys_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of all the keyword tags used on any task in this stage&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">],</span><span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Stage.yield_task_resource_usage"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.yield_task_resource_usage">[docs]</a>    <span class="k">def</span> <span class="nf">yield_task_resource_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :yields: (list of tuples) tuples contain resource usage and tags of all tasks.  The first element is the name, the second is the value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO rework with time fields</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">sja</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_successful_jobAttempt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sja</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">[</span><span class="n">jru</span> <span class="k">for</span> <span class="n">jru</span> <span class="ow">in</span> <span class="n">sja</span><span class="o">.</span><span class="n">resource_usage_short</span><span class="p">]</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="c">#add in tags to resource usage tuples</span>

    <span class="c"># def add_task(self, pcmd, tags={}, **kwargs):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Creates a new task for this stage, and saves it.</span>
    <span class="c">#     If a task with `tags` already exists in this stage, just return it.</span>
    <span class="c">#     Has the same signature as :meth:`Task.__init__` minus the stage argument.</span>
    <span class="c">#</span>
    <span class="c">#     :returns: The task added.</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     q = Task.objects.filter(stage=self,tags=tags)</span>
    <span class="c">#     # if q.count() &gt; 0:</span>
    <span class="c">#     #     return q.all()[0]</span>
    <span class="c">#</span>
    <span class="c">#     return Task.create(stage=self,pcmd=pcmd,**kwargs)</span>
</div>
<div class="viewcode-block" id="Stage.is_done"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.is_done">[docs]</a>    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: True if this stage is finished successfully or failed, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;successful&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;failed&#39;</span>
</div>
    <span class="k">def</span> <span class="nf">_are_all_tasks_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: True if all tasks have succeeded or failed in this stage, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;successful&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;failed&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_has_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executed when this stage has completed running.</span>
<span class="sd">        All it does is sets status as either failed or successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_tasks</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">num_tasks_successful</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_successful</span>
        <span class="n">num_tasks_failed</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;failed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">num_tasks_successful</span> <span class="o">==</span> <span class="n">num_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;successful&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_tasks_failed</span> <span class="o">+</span> <span class="n">num_tasks_successful</span> <span class="o">==</span> <span class="n">num_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;failed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Stage._has_finished() called, but not all tasks are completed.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">stage_status_change</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="Stage.get_tasks_by"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_tasks_by">[docs]</a>    <span class="k">def</span> <span class="nf">get_tasks_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="p">{},</span><span class="n">op</span><span class="o">=</span><span class="s">&#39;and&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An alias for :func:`Workflow.get_tasks_by` with stage=self</span>
<span class="sd">        </span>
<span class="sd">        :returns: a queryset of filtered tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_tasks_by</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Stage.get_task_by"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.get_task_by">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="p">{},</span><span class="n">op</span><span class="o">=</span><span class="s">&#39;and&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An alias for :func:`Workflow.get_task_by` with stage=self</span>
<span class="sd">        </span>
<span class="sd">        :returns: a queryset of filtered tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_task_by</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Stage.group_tasks_by"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.group_tasks_by">[docs]</a>    <span class="k">def</span> <span class="nf">group_tasks_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keys</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields tasks, grouped by tags in keys.  Groups will be every unique set of possible values of tags.</span>
<span class="sd">        For example, if you had tasks tagged by color, and shape, and you ran func:`stage.group_tasks_by`([&#39;color&#39;,&#39;shape&#39;]),</span>
<span class="sd">        this function would yield the group of tasks that exist in the various combinations of `colors` and `shapes`.</span>
<span class="sd">        So for example one of the yields might be (({&#39;color&#39;:&#39;orange&#39;n&#39;shape&#39;:&#39;circle&#39;}), [ orange_circular_tasks ])</span>
<span class="sd">        </span>
<span class="sd">        :param keys: The keys of the tags you want to group by.</span>
<span class="sd">        :yields: (a dictionary of this group&#39;s unique tags, tasks in this group).</span>
<span class="sd">        </span>
<span class="sd">        .. note:: a missing tag is considered as None and thus placed into a &#39;None&#39; group with other untagged tasks.  You should generally try to avoid this scenario and have all tasks tagged by the keywords you&#39;re grouping by.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">yield</span> <span class="p">{},</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_tag_values</span> <span class="o">=</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">key__in</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="c">#get this stage&#39;s tags</span>
            <span class="c">#filter out any tasks without all keys</span>

            <span class="n">task_id2tags</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ntv</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">task_tag_values</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;task_id&#39;</span><span class="p">]):</span>
                <span class="n">task_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span> <span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">],</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ntv</span> <span class="p">])</span>
                <span class="n">task_id2tags</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_tags</span>

            <span class="k">for</span> <span class="n">tags</span><span class="p">,</span><span class="n">task_id_and_tags_tuple</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">task_id2tags</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">task_ids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">task_id_and_tags_tuple</span> <span class="p">]</span>
                <span class="k">yield</span> <span class="n">tags</span><span class="p">,</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">task_ids</span><span class="p">)</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Stage.delete"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bulk deletes this stage and all files associated with it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deleting Stage {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deleting directory {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">bulk_delete_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Stage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0} Deleted.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</div>
    <span class="nd">@models.permalink</span>
<div class="viewcode-block" id="Stage.url"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Stage.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The URL of this stage&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;stage_view&#39;</span><span class="p">,[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Stage[{0}] {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="TaskTag"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskTag">[docs]</a><span class="k">class</span> <span class="nc">TaskTag</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A SQL row that duplicates the information of Task.tags that can be used for filtering, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Task&#39;</span><span class="p">)</span>
    <span class="n">key</span>   <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span> <span class="c"># was 63 why?</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span> <span class="c"># was CharField</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;TaskTag[self.id] {self.key}: {self.value} for Task[{task.id}]&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaskEdge"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.TaskEdge">[docs]</a><span class="k">class</span> <span class="nc">TaskEdge</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Task&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;parent_edge_set&#39;</span><span class="p">)</span>
    <span class="n">child</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Task&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;child_edge_set&#39;</span><span class="p">)</span>
<span class="c">#    tags  = PickledObjectField(null=True,default={})</span>
    <span class="s">&quot;The keys associated with the relationship.  ex, the group_by parameter of a many2one&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Edge {0.parent}-&gt;{0.child}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The object that represents the command line that gets executed.</span>
<span class="sd">    </span>
<span class="sd">    tags must be unique for all tasks in the same stage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stage</span>              <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Stage</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;The stage this task belongs to.&quot;</span><span class="p">)</span>

    <span class="n">pcmd</span>               <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s">&#39;Preformatted command.  almost always will contain special strings for TaskFiles which will later be replaced by their proper system path at execution&#39;</span><span class="p">)</span>
    <span class="n">exec_command</span>       <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s">&#39;The actual command that is executed&#39;</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">memory_requirement</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Memory to reserve for jobs in MB&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cpu_requirement</span>    <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Number of CPUs to reserve for this job&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">time_requirement</span>   <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Time required to run in minutes.  If a job runs longer it may be automatically killed.&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">successful</span>         <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;True if the task has been executed successfully, else False&quot;</span><span class="p">)</span>

    <span class="n">status</span>             <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">choices</span> <span class="o">=</span> <span class="n">status_choices</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;no_attempt&#39;</span><span class="p">)</span>
<span class="c">#   status_details     = models.CharField(max_length=100,default=&#39;&#39;,help_text=&#39;Extra information about this task\&#39;s status&#39;)</span>
    <span class="n">status_details</span>     <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&#39;Extra information about this task</span><span class="se">\&#39;</span><span class="s">s status&#39;</span><span class="p">)</span>

    <span class="n">NOOP</span>               <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">help_text</span><span class="o">=</span><span class="s">&quot;No operation.  Likely used to store an input file, this task is not meant to be executed.&quot;</span><span class="p">)</span>
    <span class="n">succeed_on_failure</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s">&quot;If True, Task will succeed and workflow will progress even if its JobAttempts fail.&quot;</span><span class="p">)</span>

    <span class="c"># cleared_output_files     = models.BooleanField(default=False,help_text=&quot;If True, output files have been deleted/cleared.&quot;)</span>
    <span class="c"># dont_delete_output_files = models.BooleanField(default=False,help_text=&quot;If True, prevents output files from being deleted even when this task becomes an intermediate and workflow.delete_intermediates == True.&quot;)</span>

    <span class="n">_parents</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;Task&#39;</span><span class="p">,</span><span class="n">related_name</span><span class="o">=</span><span class="s">&#39;_children&#39;</span><span class="p">)</span>

    <span class="n">tags</span>        <span class="o">=</span> <span class="n">PickledObjectField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="p">{})</span>
    <span class="c">#on_success = PickledObjectField(null=False)</span>

    <span class="n">created_on</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">finished_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">_output_files</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">TaskFile</span><span class="p">,</span><span class="n">related_name</span><span class="o">=</span><span class="s">&#39;task_output_set&#39;</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c">#dictionary of outputs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_files</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">_input_files</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">TaskFile</span><span class="p">,</span><span class="n">related_name</span><span class="o">=</span><span class="s">&#39;task_input_set&#39;</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_files</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c">#TODO a fix for the below should be implemented, or at least a validation that tags and stage are in fact unique</span>
<span class="c">#   Django has a bug that prevents indexing of BLOBs which is what tags is stored as</span>
<span class="c">#    class Meta:</span>
<span class="c">#        unique_together = ((&#39;tags&#39;,&#39;stage&#39;))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param stage: (Stage) The stage this task is a part of.</span>
<span class="sd">        :param pcmd: (str) The preformatted command to execute. Usually includes strings that represent TaskFiles which will be automatically parsed. Required.</span>
<span class="sd">        :param tags: (dict) A dictionary keys and values to tag the task with. These tags can later be used by methods such as :py:meth:`~Workflow.models.stage.group_tasks_by` and :py:meth:`~Workflow.models.stage.get_tasks_by` Optional.</span>
<span class="sd">        :param on_success: (method) A method to run when this task succeeds.  Method is called with one parameter named &#39;task&#39;, the successful task.</span>
<span class="sd">        :param memory_requirement: (int) How much memory to reserve for this task in MB. Optional.</span>
<span class="sd">        :param cpu_requirement: (int) How many CPUs to reserve for this task. Optional.</span>
<span class="sd">        :param time_requirement: (int) Time required in miinutes.  If a job exceeds this requirement, it will likely be killed.</span>
<span class="sd">        :param NOOP: (booean) No Operation, this task does not get executed.</span>
<span class="sd">        :param succeed_on_failure: (booean) Succeed even if JobAttempts fails.</span>
<span class="sd">        :param dont_delete_output_files: (boolean) Prevents output files from being deleted, even when this task becomes an intermediate.</span>
<span class="sd">        :param hard_reset: (bool) Deletes this task and all associated files and start it fresh. Optional.</span>
<span class="sd">        :returns: A new task instance.  The instance has not been saved to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;created_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># if len(self.tags) == 0:</span>
        <span class="c">#     raise TaskValidationError, &#39;{0} has no tags, at least one tag is required&#39;.format(self)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Task.create"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="n">pcmd</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">=</span><span class="n">pcmd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="n">tags</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Tasks belonging to a stage with the same tags detected! tags: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>

        <span class="n">task</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">job_output_dir</span><span class="p">)</span>

        <span class="c">#Create task tags    </span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.workflow"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.workflow">[docs]</a>    <span class="k">def</span> <span class="nf">workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;This task&#39;s workflow&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">workflow</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.parents"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.parents">[docs]</a>    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;This task&#39;s parents&quot;</span>
        <span class="c">#return map(lambda n: n.parent, TaskEdge.objects.filter(child=self).all())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaskEdge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.log"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;This task&#39;s workflow&#39;s log&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">log</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.file_size"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.file_size">[docs]</a>    <span class="k">def</span> <span class="nf">file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Task filesize&quot;</span>
        <span class="k">return</span> <span class="n">folder_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="n">human_readable</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.output_file_size"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.output_file_size">[docs]</a>    <span class="k">def</span> <span class="nf">output_file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Task filesize&quot;</span>
        <span class="k">return</span> <span class="n">folder_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_output_dir</span><span class="p">,</span><span class="n">human_readable</span><span class="o">=</span><span class="n">human_readable</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.output_dir"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Task output dir&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.job_output_dir"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.job_output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">job_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Where the job output goes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="s">&#39;out&#39;</span><span class="p">)</span>

    <span class="c"># @property</span>
    <span class="c"># def output_paths(self):</span>
    <span class="c">#     &quot;Dict of this task&#39;s outputs appended to this task&#39;s output_dir.&quot;</span>
    <span class="c">#     r = {}</span>
    <span class="c">#     for key,val in self.outputs.items():</span>
    <span class="c">#         r[key] = os.path.join(self.job_output_dir,val)</span>
    <span class="c">#     return r</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.jobAttempts"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.jobAttempts">[docs]</a>    <span class="k">def</span> <span class="nf">jobAttempts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Queryset of this task&#39;s jobAttempts.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Task.wall_time"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.wall_time">[docs]</a>    <span class="k">def</span> <span class="nf">wall_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Task&#39;s wall_time&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_successful_jobAttempt</span><span class="p">()</span><span class="o">.</span><span class="n">wall_time</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful</span> <span class="k">else</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Task.numAttempts"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.numAttempts">[docs]</a>    <span class="k">def</span> <span class="nf">numAttempts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;This task&#39;s number of job attempts.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Task.get_successful_jobAttempt"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.get_successful_jobAttempt">[docs]</a>    <span class="k">def</span> <span class="nf">get_successful_jobAttempt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get this task&#39;s successful job attempt.</span>
<span class="sd">        </span>
<span class="sd">        :return: this task&#39;s successful job attempt.  If there were no successful job attempts, returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;more than 1 successful job, something went wrong!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span> <span class="c"># no successful jobs</span>
</div>
<div class="viewcode-block" id="Task.set_status"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_status</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Set Task&#39;s status&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>

        <span class="k">if</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s">&#39;successful&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">successful</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0} successful!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_has_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jobAttempt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Should be executed whenever this task finishes.</span>
<span class="sd">        </span>
<span class="sd">        Sets self.status to &#39;successful&#39; or &#39;failed&#39; and self.finished_on to &#39;current_timezone&#39;</span>
<span class="sd">        Will also run self.stage._has_finished() if all tasks in the stage are done.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">jobAttempt</span> <span class="o">==</span> <span class="s">&#39;NOOP&#39;</span>
            <span class="ow">or</span> <span class="n">jobAttempt</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">succeed_on_failure</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;successful&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s">&#39;failed&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finished_on</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">task_status_change</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">_are_all_tasks_done</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">_has_finished</span><span class="p">()</span>

<div class="viewcode-block" id="Task.tag"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.tag">[docs]</a>    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tag this task with key value pairs.  If the key already exists, its value will be overwritten.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; task.tag(color=&quot;blue&quot;,shape=&quot;circle&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO don&#39;t allow tags called things like &#39;status&#39; or other task attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">tasktag</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">TaskTag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span><span class="n">defaults</span><span class="o">=</span> <span class="p">{</span><span class="s">&#39;value&#39;</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">created</span><span class="p">:</span>
                <span class="n">tasktag</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">tasktag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="Task.clear_job_output_dir"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.clear_job_output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">clear_job_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all files in this task&#39;s output directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">otf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">otf</span><span class="o">.</span><span class="n">persist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">otf</span><span class="o">.</span><span class="n">deleted_because_intermediate</span><span class="p">:</span>
                <span class="n">otf</span><span class="o">.</span><span class="n">delete_because_intermediate</span><span class="p">()</span>
</div>
    <span class="nd">@models.permalink</span>
<div class="viewcode-block" id="Task.url"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;This task&#39;s url.&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;task_view&#39;</span><span class="p">,[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_as_query_string</span><span class="p">()])</span>
</div>
<div class="viewcode-block" id="Task.tags_as_query_string"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.tags_as_query_string">[docs]</a>    <span class="k">def</span> <span class="nf">tags_as_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string of tag keys and values as a url query string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">urllib</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</div>
    <span class="nd">@transaction.commit_on_success</span>
<div class="viewcode-block" id="Task.delete"><a class="viewcode-back" href="../../../API/Workflow.html#cosmos.Workflow.models.Task.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes this task and all files associated with it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deleting {0} and it</span><span class="se">\&#39;</span><span class="s">s output directory {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
        <span class="c">#todo delete stuff in output_paths that may be extra files</span>
        <span class="k">for</span> <span class="n">ja</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobattempt_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">ja</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_tags</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_edges</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_files</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Task[{1}] {0} {2}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</pre></div></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2014, Harvard Medical School.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'.5.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>