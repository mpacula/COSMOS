{% load extras %}

<table class="table table-condensed">
    <tbody>
    <tr><th>Step</th>
        <th>Stage</th>
        <th></th>
        <th>Progress</th>
        <th>Tasks</th>
        {% if cosmos_settings.show_stage_details == "True" %}
            <th>Tags Used</th>
            <th>Stage Wall Time</th>
            <th>Avg CPU Req</th>
            <th>Avg % CPU</th>
            <th>Avg Task Wall Time</th>
            {% if details %}
                <th>Max Task Wall Time</th>
                <th>Total Task Wall Time</th>
                <th>Avg Task Blocked I/O Time</th>
            {% endif %}

            <th>Avg Mem Req</th>
            <th>Avg RSS</th>
            <th>Max RSS</th>
            {% if details%}
                <th>Avg Virtual Ram</th>
                <th>Started</th>
                <th>Finished</th>
            {% endif %}
        {% endif %}
        <th>Output File Size</th>
    </tr>
    {% for stage in stages %}
        <tr onclick="window.location.href = '{{stage.url}}';" style="cursor:pointer">
        <td>{{stage.order_in_workflow}}.</td>
        <td>[{{stage.id}}] <a href="{{stage.url}}"><strong>{{stage.name|underscore2space}}</strong></a></td>

            <td>
                {%with status=stage.status %}
                    {%if status == "successful"%}<i class="icon-thumbs-up" rel="tooltip" title="Successful"></i>{%endif%}
                    {%if status == "failed"%}<i class="icon-thumbs-down" rel="tooltip" title="Failed"></i>{%endif%}
                    {%if status == "in_progress"%}<i class="icon-refresh" rel="tooltip" title="In Progress"></i>{%endif%}
                {%endwith%}
                </td>
            <td><div style="padding:0px;margin:0px" class="progress progress-{% status2csstype stage.status %} progress-striped" rel="tooltip" title="{{stage.percent_done}}% Completed" data-placement="right">
                    <div class="bar" style="opacity:.75;width:{{stage.percent_done}}%"></div>
                </div></td>
            <td>{{stage.num_tasks_successful}}/{{stage.num_tasks}}</td>
            {% if cosmos_settings.show_stage_details == "True" %}
                <td>{%if 0 %}{{stage.get_all_tag_keys_used|join:', '}}{%endif%}</td>
                <td>{{stage.wall_time.seconds|format_time}}</td>
                <td>{% get_task_stat stage "cpu_requirement" "Avg"%}</td>
                <td>{% get_sjob_stat stage "percent_cpu" "Avg" "format_percent"%}</td>
                <td>{% get_sjob_stat stage "wall_time" "Avg" "format_time"%}</td>
                {% if details and cosmos_settings.show_stage_details == 'True' %}
                <td>{% get_sjob_stat stage "wall_time" "Max" "format_time"%}</td>
                <td>{% get_sjob_stat stage "wall_time" "Sum" "format_time"%}</td>
                <td>{% get_sjob_stat stage "block_io_delays" "Avg" "format_time"%}</td>
                {% endif %}

                <td>{% get_task_stat stage "memory_requirement" "Avg" "format_memory_mb"%}</td>
                <td>{% get_sjob_stat stage "avg_rss_mem" "Avg" "format_memory_kb"%}</td>
                <td>{% get_sjob_stat stage "max_rss_mem" "Max" "format_memory_kb"%}</td>
                {% if details %}
                <td>{% get_sjob_stat stage "avg_virtual_mem" "Avg" "format_memory_kb"%}</td>
               <td>{{stage.started_on|date:"SHORT_DATETIME_FORMAT"}}</td>
               <td>{{stage.finished_on|date:"SHORT_DATETIME_FORMAT"}}</td>
               {% endif %}
            {% endif %}
            <td>{%if cosmos_settings.show_stage_file_sizes == "True"%}{{stage.file_size}}{%else%}off{%endif%}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
